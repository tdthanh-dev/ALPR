<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nh·∫≠n d·∫°ng bi·ªÉn s·ªë xe</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        .container {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 5px 5px 0 0;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #3498db;
            color: white;
        }

        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
            animation: fadeEffect 1s;
        }

        @keyframes fadeEffect {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        button:hover {
            background-color: #2980b9;
        }

        .result {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .plate-info {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .preview-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .preview-box {
            flex: 1;
            margin-right: 10px;
            text-align: center;
        }

        .preview-box img,
        .preview-box video,
        .preview-box canvas {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading img {
            width: 50px;
            height: 50px;
        }

        #errorMessage {
            color: #e74c3c;
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }

        .camera-container {
            display: none;
        }

        .camera-controls {
            display: none;
        }

        #cameraPreview,
        #exitCameraPreview {
            display: none;
        }

        #captureCanvas,
        #exitCaptureCanvas {
            display: none;
        }

        #capturedImagePreview,
        #exitCapturedImagePreview {
            display: none;
        }

        .permission-alert {
            display: none;
        }
    </style>
</head>

<body>
    <h1>H·ªá th·ªëng nh·∫≠n d·∫°ng bi·ªÉn s·ªë xe</h1>

    <div class="container">
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'fileUpload')">Xe v√†o b√£i</button>
            <button class="tablinks" onclick="openTab(event, 'carExit')">Xe ra b√£i</button>
            <button class="tablinks" onclick="openTab(event, 'parkingList')">Danh s√°ch xe trong b√£i</button>
        </div>

        <div id="fileUpload" class="tabcontent" style="display: block;">
            <h3>Xe v√†o b√£i</h3>
            <div class="form-group">
                <label for="imageFile">Ch·ª•p ·∫£nh bi·ªÉn s·ªë xe v√†o b√£i (JPG, PNG)</label>
                <input type="file" id="imageFile" accept="image/jpeg, image/png" onchange="previewImage()">
            </div>

            <button type="button" onclick="toggleCamera('entry')" style="background-color: #27ae60; display: none;">B·∫≠t
                camera</button>

            <div id="entryPermissionAlert" class="permission-alert">
                <p><strong>C·∫ßn c·∫•p quy·ªÅn camera:</strong> Vui l√≤ng ch·∫•p nh·∫≠n y√™u c·∫ßu truy c·∫≠p camera t·ª´ tr√¨nh duy·ªát ƒë·ªÉ
                    s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.</p>
                <p>N·∫øu b·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn, vui l√≤ng l√†m m·ªõi trang v√† ch·∫•p nh·∫≠n y√™u c·∫ßu ho·∫∑c c·∫•u h√¨nh l·∫°i quy·ªÅn camera
                    trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.</p>
            </div>

            <div class="camera-container" id="entryCameraContainer" style="display: none;">
                <video id="cameraPreview" autoplay playsinline></video>
                <canvas id="captureCanvas"></canvas>
                <img id="capturedImagePreview" alt="·∫¢nh ƒë√£ ch·ª•p">

                <div class="camera-controls">
                    <button id="captureButton" onclick="captureAndUpload('entry')" style="display: none;">Ch·ª•p
                        ·∫£nh</button>
                    <button id="retakeButton" onclick="retakeImage('entry')"
                        style="display: none; background-color: #e67e22;">Ch·ª•p l·∫°i</button>
                    <button id="useImageButton" onclick="useImage('entry')"
                        style="display: none; background-color: #2ecc71;">S·ª≠ d·ª•ng ·∫£nh n√†y</button>
                </div>
            </div>

            <div class="preview-container">
                <div class="preview-box">
                    <p>Xem tr∆∞·ªõc ·∫£nh</p>
                    <img id="imagePreview" src="/api/placeholder/400/320" alt="Xem tr∆∞·ªõc ·∫£nh">
                </div>
            </div>

            <button onclick="uploadImage('in')">Qu√©t bi·ªÉn s·ªë v√† cho xe v√†o b√£i</button>
        </div>

        <div id="carExit" class="tabcontent">
            <h3>Xe ra b√£i</h3>
            <div class="form-group">
                <label for="exitImageFile">Ch·ª•p ·∫£nh bi·ªÉn s·ªë xe ra b√£i (JPG, PNG)</label>
                <input type="file" id="exitImageFile" accept="image/jpeg, image/png" onchange="previewExitImage()">
            </div>

            <button type="button" onclick="toggleCamera('exit')" style="background-color: #27ae60; display: none;">B·∫≠t
                camera</button>

            <div id="exitPermissionAlert" class="permission-alert">
                <p><strong>C·∫ßn c·∫•p quy·ªÅn camera:</strong> Vui l√≤ng ch·∫•p nh·∫≠n y√™u c·∫ßu truy c·∫≠p camera t·ª´ tr√¨nh duy·ªát ƒë·ªÉ
                    s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.</p>
                <p>N·∫øu b·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn, vui l√≤ng l√†m m·ªõi trang v√† ch·∫•p nh·∫≠n y√™u c·∫ßu ho·∫∑c c·∫•u h√¨nh l·∫°i quy·ªÅn camera
                    trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.</p>
            </div>

            <div class="camera-container" id="exitCameraContainer" style="display: none;">
                <video id="exitCameraPreview" autoplay playsinline></video>
                <canvas id="exitCaptureCanvas"></canvas>
                <img id="exitCapturedImagePreview" alt="·∫¢nh ƒë√£ ch·ª•p">

                <div class="camera-controls">
                    <button id="exitCaptureButton" onclick="captureAndUpload('exit')" style="display: none;">Ch·ª•p
                        ·∫£nh</button>
                    <button id="exitRetakeButton" onclick="retakeImage('exit')"
                        style="display: none; background-color: #e67e22;">Ch·ª•p l·∫°i</button>
                    <button id="exitUseImageButton" onclick="useImage('exit')"
                        style="display: none; background-color: #2ecc71;">S·ª≠ d·ª•ng ·∫£nh n√†y</button>
                </div>
            </div>

            <div class="preview-container">
                <div class="preview-box">
                    <p>Xem tr∆∞·ªõc ·∫£nh</p>
                    <img id="exitImagePreview" src="/api/placeholder/400/320" alt="Xem tr∆∞·ªõc ·∫£nh">
                </div>
            </div>

            <button onclick="uploadImage('out')">Qu√©t bi·ªÉn s·ªë v√† cho xe ra b√£i</button>
        </div>

        <div id="parkingList" class="tabcontent">
            <h3>Danh s√°ch xe trong b√£i</h3>
            <div class="search-box" style="margin-bottom: 15px;">
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm bi·ªÉn s·ªë..."
                    style="padding: 8px; width: 300px;">
                <button onclick="searchVehicles()" style="margin-left: 10px;">T√¨m ki·∫øm</button>
            </div>

            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Bi·ªÉn s·ªë</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Th·ªùi gian v√†o</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Lo·∫°i xe</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Tr·∫°ng th√°i</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="vehicleTableBody">
                    <!-- D·ªØ li·ªáu xe s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                </tbody>
            </table>
        </div>

        <div id="errorMessage"></div>

        <div class="loading" id="loadingIndicator">
            <p>ƒêang x·ª≠ l√Ω...</p>
            <svg width="50" height="50" viewBox="0 0 50 50">
                <circle cx="25" cy="25" r="20" fill="none" stroke="#3498db" stroke-width="5"
                    stroke-dasharray="31.4 31.4">
                    <animateTransform attributeName="transform" attributeType="XML" type="rotate" from="0 25 25"
                        to="360 25 25" dur="1s" repeatCount="indefinite" />
                </circle>
            </svg>
        </div>

        <div class="result" id="resultContainer" style="display: none;">
            <h2>K·∫øt qu·∫£ nh·∫≠n d·∫°ng</h2>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>

        // D·ªØ li·ªáu m·∫´u cho th·∫ª th√†nh vi√™n
        const sampleMembers = [
            {
                id: 1,
                licensePlate: "29A-12345",
                ownerName: "Nguy·ªÖn VƒÉn A",
                vehicleType: "CAR",
                isMember: true
            },
            {
                id: 2,
                licensePlate: "30A-54321",
                ownerName: "Tr·∫ßn Th·ªã B",
                vehicleType: "MOTORCYCLE",
                isMember: true
            },
            {
                id: 3,
                licensePlate: "31A-98765",
                ownerName: "L√™ VƒÉn C",
                vehicleType: "CAR",
                isMember: true
            }
        ];

        // Gi√° ti·ªÅn theo lo·∫°i xe (ƒë∆°n v·ªã: VND/gi·ªù)
        const priceRates = {
            CAR: 20000,         // 20k/gi·ªù cho √¥ t√¥
            MOTORCYCLE: 5000,   // 5k/gi·ªù cho xe m√°y
            TRUCK: 30000,       // 30k/gi·ªù cho xe t·∫£i
            OTHER: 10000        // 10k/gi·ªù cho c√°c lo·∫°i xe kh√°c
        };

        // Kh·ªüi t·∫°o d·ªØ li·ªáu trong localStorage
        function initLocalStorage() {
            // Kh·ªüi t·∫°o danh s√°ch th√†nh vi√™n
            if (!localStorage.getItem('members')) {
                localStorage.setItem('members', JSON.stringify(sampleMembers));
            }

            // Kh·ªüi t·∫°o danh s√°ch xe trong b√£i
            if (!localStorage.getItem('parkingLot')) {
                localStorage.setItem('parkingLot', JSON.stringify([]));
            }

            // Kh·ªüi t·∫°o l·ªãch s·ª≠ xe ra v√†o
            if (!localStorage.getItem('parkingHistory')) {
                localStorage.setItem('parkingHistory', JSON.stringify([]));
            }
        }

        // Kh·ªüi t·∫°o khi trang t·∫£i
        document.addEventListener('DOMContentLoaded', function () {
            initLocalStorage();
            loadParkingLot();
        });

        // M·ªü tab
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            // D·ª´ng camera n·∫øu chuy·ªÉn sang tab kh√°c
            if (tabName !== 'cameraUpload' && stream) {
                stopCamera();
            }

            if (tabName === 'parkingList') {
                loadParkingLot();
            }
        }

        function previewImage() {
            const file = document.getElementById('imageFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('imagePreview').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        function previewExitImage() {
            const file = document.getElementById('exitImageFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('exitImagePreview').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        // Hi·ªÉn th·ªã l·ªói
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            console.error(message); // Ghi log l·ªói ra console ƒë·ªÉ debug
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
        function showSuccess(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.color = '#2ecc71';
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
                errorElement.style.color = '#e74c3c';
            }, 5000);
        }

        // T·∫£i ·∫£nh l√™n v√† x·ª≠ l√Ω xe v√†o/ra
        function uploadImage(type) {
            const fileId = type === 'in' ? 'imageFile' : 'exitImageFile';
            const fileInput = document.getElementById(fileId);
            if (!fileInput.files || fileInput.files.length === 0) {
                showError("Vui l√≤ng ch·ªçn m·ªôt ·∫£nh ƒë·ªÉ t·∫£i l√™n");
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('image', file);

            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('resultContainer').style.display = 'none';

            // G·ª≠i y√™u c·∫ßu ƒë·∫øn API
            fetch('/detect_license_plate', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß');
                    }
                    return response.json();
                })
                .then(data => {
                    displayResults(data);

                    if (data.status === 'success' && data.plates_count > 0) {
                        const licensePlate = data.plates[0].formatted_text;

                        if (type === 'in') {
                            processVehicleEntry(licensePlate, data.plates[0].crop_base64);
                        } else {
                            processVehicleExit(licensePlate);
                        }
                    } else {
                        showError("Kh√¥ng nh·∫≠n d·∫°ng ƒë∆∞·ª£c bi·ªÉn s·ªë xe");
                    }
                })
                .catch(error => {
                    showError("L·ªói: " + error.message);
                })
                .finally(() => {
                    document.getElementById('loadingIndicator').style.display = 'none';
                });
        }

        // C·∫£i thi·ªán h√†m ƒë·ªãnh d·∫°ng th·ªùi gian
        function formatDateTime(isoString) {
            if (!isoString) return 'N/A';

            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return 'Th·ªùi gian kh√¥ng h·ª£p l·ªá';

                return new Intl.DateTimeFormat('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).format(date);
            } catch (e) {
                console.error("L·ªói ƒë·ªãnh d·∫°ng th·ªùi gian:", e);
                return 'L·ªói th·ªùi gian';
            }
        }

        function calculateParkingDuration(startTime, endTime = null) {
            try {
                const start = new Date(startTime);
                const end = endTime ? new Date(endTime) : new Date();

                if (isNaN(start.getTime())) return "N/A";

                const durationMs = end - start;
                if (durationMs < 0) return "0 ph√∫t";

                const hours = Math.floor(durationMs / (1000 * 60 * 60));
                const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));

                if (hours > 0) {
                    return `${hours} gi·ªù ${minutes} ph√∫t`;
                } else {
                    return `${minutes} ph√∫t`;
                }
            } catch (e) {
                console.error("L·ªói t√≠nh th·ªùi gian ƒë·ªó xe:", e);
                return "N/A";
            }
        }

        // C·∫≠p nh·∫≠t h√†m x·ª≠ l√Ω xe v√†o b√£i
        function processVehicleEntry(licensePlate, imageBase64) {
            const parkingLot = JSON.parse(localStorage.getItem('parkingLot') || '[]');

            // Ki·ªÉm tra xem xe ƒë√£ c√≥ trong b√£i ch∆∞a
            const existingVehicle = parkingLot.find(v => normalizeLicensePlate(v.licensePlate) === normalizeLicensePlate(licensePlate));
            if (existingVehicle) {
                showError(`Xe bi·ªÉn s·ªë ${licensePlate} ƒë√£ c√≥ trong b√£i!`);
                return;
            }

            // Ki·ªÉm tra xem xe c√≥ ƒëƒÉng k√Ω th·∫ª hay kh√¥ng
            const cardInfo = checkCardRegistration(licensePlate);
            const hasRegisteredCard = cardInfo.isRegistered;

            // Ki·ªÉm tra t·ª´ danh s√°ch th√†nh vi√™n c≈©
            const members = JSON.parse(localStorage.getItem('members') || '[]');
            const isMember = members.some(m => normalizeLicensePlate(m.licensePlate) === normalizeLicensePlate(licensePlate)) || hasRegisteredCard;

            const entryTime = new Date().toISOString();
            const vehicleInfo = {
                licensePlate: licensePlate,
                entryTime: entryTime,
                imageBase64: imageBase64,
                isMember: isMember,
                vehicleType: determineVehicleType(licensePlate, members),
                status: 'in',
                ownerName: cardInfo.isRegistered ? cardInfo.card.ownerName : 'Kh√°ch v√£ng lai'
            };

            parkingLot.push(vehicleInfo);
            localStorage.setItem('parkingLot', JSON.stringify(parkingLot));

            updateParkingHistory(vehicleInfo);

            if (isMember) {
                showSuccess(`Th√†nh vi√™n v·ªõi bi·ªÉn s·ªë ${licensePlate} ƒë√£ v√†o b√£i th√†nh c√¥ng! (${formatDateTime(entryTime)})`);
            } else {
                showSuccess(`Xe v·ªõi bi·ªÉn s·ªë ${licensePlate} ƒë√£ v√†o b√£i, b·∫Øt ƒë·∫ßu t√≠nh ph√≠! (${formatDateTime(entryTime)})`);
            }

            if (document.getElementById('parkingList').style.display === 'block') {
                loadParkingLot();
            }
        }

        function processVehicleExit(licensePlate) {
            const parkingLot = JSON.parse(localStorage.getItem('parkingLot') || '[]');

            const vehicleIndex = parkingLot.findIndex(v => normalizeLicensePlate(v.licensePlate) === normalizeLicensePlate(licensePlate));

            if (vehicleIndex === -1) {
                showError(`Kh√¥ng t√¨m th·∫•y xe bi·ªÉn s·ªë ${licensePlate} trong b√£i!`);
                return;
            }

            const vehicle = parkingLot[vehicleIndex];
            const exitTime = new Date().toISOString();

            try {
                const entryTime = new Date(vehicle.entryTime);
                const exitDateTime = new Date(exitTime);

                const parkingHours = (exitDateTime - entryTime) / (1000 * 60 * 60);

                let fee = 0;
                if (!vehicle.isMember) {
                    fee = calculateParkingFee(vehicle.vehicleType, parkingHours);
                }

                vehicle.exitTime = exitTime;
                vehicle.parkingDuration = parkingHours;
                vehicle.fee = fee;
                vehicle.status = 'out';

                parkingLot.splice(vehicleIndex, 1);
                localStorage.setItem('parkingLot', JSON.stringify(parkingLot));

                updateParkingHistory(vehicle);

                if (vehicle.isMember) {
                    showSuccess(`Th√†nh vi√™n v·ªõi bi·ªÉn s·ªë ${licensePlate} ƒë√£ ra b√£i th√†nh c√¥ng! (${formatDateTime(exitTime)})`);
                } else {
                    showSuccess(`Xe v·ªõi bi·ªÉn s·ªë ${licensePlate} ƒë√£ ra b√£i. Ph√≠ g·ª≠i xe: ${formatCurrency(fee)}! (${formatDateTime(exitTime)})`);
                }

                if (document.getElementById('parkingList').style.display === 'block') {
                    loadParkingLot();
                }
            } catch (error) {
                console.error("L·ªói x·ª≠ l√Ω th·ªùi gian:", error);
                showError(`L·ªói x·ª≠ l√Ω th·ªùi gian cho xe ${licensePlate}. Vui l√≤ng th·ª≠ l·∫°i.`);
            }
        }

        function viewVehicleDetails(licensePlate) {
            const parkingLot = JSON.parse(localStorage.getItem('parkingLot') || '[]');
            const vehicle = parkingLot.find(v => normalizeLicensePlate(v.licensePlate) === normalizeLicensePlate(licensePlate));

            if (!vehicle) {
                showError("Kh√¥ng t√¨m th·∫•y th√¥ng tin xe");
                return;
            }

            try {
                const entryTime = formatDateTime(vehicle.entryTime);
                const memberStatus = vehicle.isMember ? 'Th√†nh vi√™n' : 'Kh√°ch v√£ng lai';

                let vehicleType = 'Kh√°c';
                switch (vehicle.vehicleType) {
                    case 'CAR': vehicleType = '√î t√¥'; break;
                    case 'MOTORCYCLE': vehicleType = 'Xe m√°y'; break;
                    case 'TRUCK': vehicleType = 'Xe t·∫£i'; break;
                }

                const parkingDuration = calculateParkingDuration(vehicle.entryTime);

                let currentFee = 0;
                if (!vehicle.isMember) {
                    const now = new Date();
                    const entry = new Date(vehicle.entryTime);
                    const parkingHours = (now - entry) / (1000 * 60 * 60);
                    currentFee = calculateParkingFee(vehicle.vehicleType, parkingHours);
                }

                const resultContainer = document.getElementById('resultContainer');
                const resultContent = document.getElementById('resultContent');

                resultContent.innerHTML = `
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;">
                        <h3>Th√¥ng tin xe bi·ªÉn s·ªë: ${vehicle.licensePlate}</h3>
                        <div style="display: flex; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <img src="data:image/jpeg;base64,${vehicle.imageBase64}" 
                                     alt="Bi·ªÉn s·ªë" style="max-width: 100%; max-height: 200px;">
                            </div>
                            <div style="flex: 1; padding-left: 15px;">
                                <p><strong>Ch·ªß xe:</strong> ${vehicle.ownerName || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                                <p><strong>Lo·∫°i xe:</strong> ${vehicleType}</p>
                                <p><strong>Th·ªùi gian v√†o:</strong> ${entryTime}</p>
                                <p><strong>Tr·∫°ng th√°i:</strong> ${memberStatus}</p>
                                <p><strong>Th·ªùi gian ƒë√£ ƒë·ªó:</strong> ${parkingDuration}</p>
                                ${!vehicle.isMember ? `<p><strong>Ph√≠ hi·ªán t·∫°i:</strong> ${formatCurrency(currentFee)}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                resultContainer.style.display = 'block';
            } catch (error) {
                console.error("L·ªói hi·ªÉn th·ªã chi ti·∫øt xe:", error);
                showError("L·ªói hi·ªÉn th·ªã th√¥ng tin xe. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        }

        // T·∫£i danh s√°ch xe trong b√£i
        function loadParkingLot(searchTerm = '') {
            const tableBody = document.getElementById('vehicleTableBody');
            const parkingLot = JSON.parse(localStorage.getItem('parkingLot') || '[]');

            let filteredVehicles = parkingLot;
            if (searchTerm) {
                searchTerm = searchTerm.toLowerCase();
                filteredVehicles = parkingLot.filter(vehicle =>
                    vehicle.licensePlate.toLowerCase().includes(searchTerm)
                );
            }

            tableBody.innerHTML = '';

            if (filteredVehicles.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" style="text-align:center; padding: 10px;">Kh√¥ng c√≥ xe n√†o trong b√£i</td>';
                tableBody.appendChild(row);
                return;
            }

            filteredVehicles.forEach(vehicle => {
                const row = document.createElement('tr');

                const entryTime = formatDateTime(vehicle.entryTime);
                const memberStatus = vehicle.isMember ?
                    '<span style="color: green;">Th√†nh vi√™n</span>' :
                    '<span style="color: blue;">Kh√°ch v√£ng lai</span>';

                let vehicleType = 'Kh√°c';
                switch (vehicle.vehicleType) {
                    case 'CAR': vehicleType = '√î t√¥'; break;
                    case 'MOTORCYCLE': vehicleType = 'Xe m√°y'; break;
                    case 'TRUCK': vehicleType = 'Xe t·∫£i'; break;
                }

                row.innerHTML = `
                    <td style="border: 1px solid #ddd; padding: 8px;">${vehicle.licensePlate}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${entryTime}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${vehicleType}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${memberStatus}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <button onclick="viewVehicleDetails('${vehicle.licensePlate}')" style="background-color: #3498db; padding: 5px 10px; margin-right: 5px;">Xem</button>
                        <button onclick="exitVehicle('${vehicle.licensePlate}')" style="background-color: #e74c3c; padding: 5px 10px;">Xe ra</button>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // T√¨m ki·∫øm xe trong b√£i
        function searchVehicles() {
            const searchTerm = document.getElementById('searchInput').value;
            loadParkingLot(searchTerm);
        }

        // Cho xe ra b√£i t·ª´ danh s√°ch
        function exitVehicle(licensePlate) {
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën cho xe ${licensePlate} ra kh·ªèi b√£i kh√¥ng?`)) {
                processVehicleExit(licensePlate);
            }
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£ nh·∫≠n d·∫°ng bi·ªÉn s·ªë
        function displayResults(data) {
            const resultContainer = document.getElementById('resultContainer');
            const resultContent = document.getElementById('resultContent');

            resultContent.innerHTML = '';

            if (data.status === 'success') {
                if (data.plates_count === 0) {
                    resultContent.innerHTML = '<p>Kh√¥ng ph√°t hi·ªán bi·ªÉn s·ªë xe trong ·∫£nh.</p>';
                } else {
                    data.plates.forEach((plate, index) => {
                        const plateDiv = document.createElement('div');
                        plateDiv.className = 'plate-info';

                        let plateHtml = `
                            <h3>üìå Bi·ªÉn s·ªë ${index + 1}: ${plate.formatted_text}</h3>
                            <div style="display: flex; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <img src="data:image/jpeg;base64,${plate.crop_base64}" 
                                         alt="Bi·ªÉn s·ªë" style="max-width: 100%; max-height: 200px;">
                                </div>
                                <div style="flex: 1; padding-left: 15px;">
                                    <p><strong>Bi·ªÉn s·ªë ƒë√£ nh·∫≠n d·∫°ng:</strong> ${plate.formatted_text}</p>
                                    <p><strong>D√≤ng tr√™n:</strong> ${plate.top_text}</p>
                                    <p><strong>D√≤ng d∆∞·ªõi:</strong> ${plate.bottom_text}</p>
                                    <p><strong>V·ªã tr√≠ bi·ªÉn s·ªë:</strong> [${plate.bbox.join(', ')}]</p>
                                </div>
                            </div>
                        `;

                        plateDiv.innerHTML = plateHtml;
                        resultContent.appendChild(plateDiv);
                    });
                }
            } else {
                resultContent.innerHTML = `<p>L·ªói: ${data.error || 'Kh√¥ng th·ªÉ x·ª≠ l√Ω y√™u c·∫ßu'}</p>`;
            }

            resultContainer.style.display = 'block';
        }

        // C·∫≠p nh·∫≠t l·ªãch s·ª≠ g·ª≠i xe
        function updateParkingHistory(vehicleInfo) {
            const history = JSON.parse(localStorage.getItem('parkingHistory') || '[]');
            history.push(vehicleInfo);
            localStorage.setItem('parkingHistory', JSON.stringify(history));
        }

        // X√°c ƒë·ªãnh lo·∫°i xe d·ª±a tr√™n bi·ªÉn s·ªë v√† th√¥ng tin th√†nh vi√™n
        function determineVehicleType(licensePlate, members) {
            const member = members.find(m => normalizeLicensePlate(m.licensePlate) === normalizeLicensePlate(licensePlate));
            if (member) {
                return member.vehicleType;
            }

            if (licensePlate.startsWith('29') || licensePlate.startsWith('30')) {
                return "CAR";
            } else if (licensePlate.startsWith('36')) {
                return "MOTORCYCLE";
            } else {
                return "OTHER";
            }
        }

        // T√≠nh ph√≠ g·ª≠i xe
        function calculateParkingFee(vehicleType, hours) {
            const rate = priceRates[vehicleType] || priceRates.OTHER;
            const roundedHours = Math.ceil(hours);
            return rate * roundedHours;
        }

        // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        // Chu·∫©n h√≥a bi·ªÉn s·ªë xe ƒë·ªÉ so s√°nh
        function normalizeLicensePlate(licensePlate) {
            if (!licensePlate) return '';
            return licensePlate.toString().replace(/[\s-\.]/g, '').toUpperCase();
        }

        // Ki·ªÉm tra xem bi·ªÉn s·ªë c√≥ ƒëƒÉng k√Ω th·∫ª hay kh√¥ng
        function checkCardRegistration(licensePlate) {
            try {
                const normalizedPlate = normalizeLicensePlate(licensePlate);
                const cards = JSON.parse(localStorage.getItem('cards') || '[]');
                const card = cards.find(c => normalizeLicensePlate(c.licensePlate) === normalizedPlate);

                if (card) {
                    return {
                        isRegistered: true,
                        card: card
                    };
                }

                return {
                    isRegistered: false,
                    card: null
                };
            } catch (e) {
                console.error("L·ªói ki·ªÉm tra ƒëƒÉng k√Ω th·∫ª:", e);
                return {
                    isRegistered: false,
                    card: null
                };
            }
        }

    </script>
</body>

</html>